const express = require('express');
const app = express();
const port = process.env.PORT || 3000;

// === 1) Gregorian → JD ===
function gregorianToJD(year, month, day) {
  if (month <= 2) {
    year -= 1;
    month += 12;
  }
  const A = Math.floor(year / 100);
  const B = 2 - A + Math.floor(A / 4);
  return Math.floor(365.25 * (year + 4716))
       + Math.floor(30.6001 * (month + 1))
       + day + B - 1524.5;
}

// === 2) Твои SEALS ===
const SEALS_RU = [
    {
      "name": "Красный Дракон (Имиш)",
      "short": "Красный Дракон",
      "desc": "Рождение. Бытие. Питание. Память. Откройся энергиям Рождения и Упования, высшей веры во всемогущество бытия, и пусть они выражают себя в твоей жизни. Фокусируйся как на самостоятельности, так и на благодарном принятии необходимого питания от Вселенной. Только так жизнь поможет тебе осуществить твои глубинные потребности. Позволь энергии рождения инициировать и претворять в жизнь все твои начинания!",
      "chakra": "Горловая чакра",
      "finger": "Указательный палец правой руки",
      "direction": "Восток — инициирует",
      "motto": "Я питаю рождение моего бытия первозданным доверием."
    },
    {
      "name": "Белый Ветер (Ик)",
      "short": "Белый Ветер",
      "desc": "Дух. Дыхание. Коммуникации и связи. Получай и выражай энергии Духа и Связности. Фокусируйся на присутствии Духа во всех твоих делах. Будь созвучен со своим естественным вдохновением! Пусть Дух поможет тебе выражать сокровенную Истину твоего бытия! Движение Духа — это всемогущее Дыхание самого бытия, объединяющего всё сущее.",
      "chakra": "Сердечная чакра",
      "finger": "Средний палец правой руки",
      "direction": "Север — очищает",
      "motto": "Дыша вдохновением, я строю спираль созидания."
    },
    {
      "name": "Синяя Ночь (Акбаль)",
      "short": "Синяя Ночь",
      "desc": "Изобилие. Интуиция. Сновидение. Принимай и выражай энергии Сновидения и Изобилия. Войди в святилище своего сердца, в его сокровенную тьму — арену твоих внутренних мистерий. Стань единым со своим нерушимым покоем и интуицией. Настраивайся на естественное изобилие, окружающее тебя, и мечтай!",
      "chakra": "Чакра солнечного сплетения",
      "finger": "Безымянный палец правой руки",
      "direction": "Запад — трансформирует",
      "motto": "Интуиция открывает мне двери мечты в святилище изобилия."
    },
    {
      "name": "Жёлтое Семя (Кан)",
      "short": "Жёлтое Семя",
      "desc": "Цветение. Осознанность. Целеустремлённость. Получай и выражай силы Осознанности и Цветения. Фокусируйся на всемогуществе твоих намерений. Нацеливай свои желания, и тогда они осуществятся. Высаживай семена сущностно важных явлений с предельной точностью. Питай и взращивай их, наблюдая за их разрастанием. Ощущай себя живым цветком!",
      "chakra": "Корневая чакра (копчик)",
      "finger": "Мизинец правой руки",
      "direction": "Юг — расширяет",
      "motto": "Моя осознанность даёт возможность расцвести семенам творения."
    },
    {
      "name": "Красный Змей (Чик-Чан)",
      "short": "Красный Змей",
      "desc": "Жизненная сила. Инстинкт. Выживание. Сексуальность. Получай и выражай силы Жизненности и Инстинкта. Вслушивайся в первозданную мудрость своего физического храма и чти его совершенство. Настраивайся на свою страстность, жизненность, чувственность и сексуальность. Чувствуй, как пробуждается и расцветает твоя кундалини!",
      "chakra": "Коронная чакра (макушка)",
      "finger": "Большой палец правой ноги",
      "direction": "Восток — инициирует",
      "motto": "Основа моей жизненной силы — инстинкт моей страсти."
    },
    {
      "name": "Белый Соединитель Миров (Кими)",
      "short": "Белый Соединитель Миров",
      "desc": "Смерть. Благоприятная возможность. Выравнивание. Получай и выражай силу Смерти и Самоотдачи. Фокусируйся на том, чтобы позволить произойти неизбежным смертям и разлукам. Так ты откроешь врата обновлению и новым благоприятным возможностям. Отпускай и прощай! Бери под контроль побуждения своей низшей природы, чтобы ощутить Благодать Божественного Плана! Перекидывать мостики между мирами тебе поможет сила уравновешенности и непредвзятости.",
      "chakra": "Горловая чакра",
      "finger": "Второй палец правой ноги",
      "direction": "Север — очищает",
      "motto": "Я покорен своей благоприятной возможности."
    },
    {
      "name": "Синяя Рука (Маник)",
      "short": "Синяя Рука",
      "desc": "Свершение. Исцеление. Знание. Получай и выражай силы Свершения и Целения. Наполняй свою жизнь Свершением, в самом глубинном смысле этого слова. Исцеляй все уровни человеческого бытия! Оттачивай мастерство привносить в свою жизнь то, что желанно тебе. Приводи к совершенству и завершению те сферы своей жизни, которые помогут тебе выйти на следующий, неизведанный уровень бытия.",
      "chakra": "Сердечная чакра",
      "finger": "Средний палец правой ноги",
      "direction": "Запад — трансформирует",
      "motto": "Я здесь, дабы свершить исцеление Планеты."
    },
    {
      "name": "Жёлтая Звезда (Ламат)",
      "short": "Жёлтая Звезда",
      "desc": "Изящество. Искусство. Создание Красоты. Получай и выражай силы Красоты и Изящества. Фокусируйся на вхождении в поток высшей утончённости, естественной лёгкости, текучести и покоя. Участвуй в создании и распространении гармонии в мире! Освободись от всякого самоосуждения и пойми, что твоя жизнь — произведение искусства!",
      "chakra": "Чакра солнечного сплетения",
      "finger": "Безымянный палец правой ноги",
      "direction": "Юг — расширяет",
      "motto": "Я пробуждена к красоте, дышу изяществом и излучаю искусство."
    },
    {
      "name": "Красная Луна (Мулук)",
      "short": "Красная Луна",
      "desc": "Изначальная Вода. Поток. Очищение. Получай и выражай силу Вселенского Потока Очищения. Фокусируйся на очистке инструмента своего восприятия — единства тела и разума. Это возможно благодаря его постоянной взаимосвязи с Высшим «Я». Питай своё тело, основу своего мира, вибрациями собственной цельности. Воссоединение с самим собой ведёт к полной пробуждённости в каждый миг твоей жизни. Пробудив в себе текучесть и гибкость, ты позволишь событиям в полном смысле проистекать!",
      "chakra": "Корневая чакра",
      "finger": "Мизинец правой ноги",
      "direction": "Восток — инициирует",
      "motto": "Я есмь поток очищения, влившийся в многомерность моего существа."
    },
  {
      "name": "Белая Собака (Ок)",
      "short": "Белая Собака",
      "desc": "Сердце. Преданность. Любовь. Получай и выражай силы Любви и Преданности. Фокусируйся на преодолении ограничивающих комплексов в эмоциональной сфере, активируя свою духовную силу и стремление к взаимодействию. Настраивайся на Единое Сердце Вселенной! Ищи новые уровни воссоединения со своими спутниками на жизненном пути! Будь предан сокровенной истине твоего существа, своего пути и предназначения.",
      "chakra": "Коронная чакра",
      "finger": "Большой палец левой руки",
      "direction": "Север — очищает",
      "motto": "Единое сердце, любовь и преданность — спутники моей судьбы."
    },
    {
      "name": "Синяя Обезьяна (Чуэн)",
      "short": "Синяя Обезьяна",
      "desc": "Магия. Иллюзия. Игра. Получай и выражай силу Магии и Игры. Фокусируйся на том, что твоя жизнь — праздник твоего божественного внутреннего ребёнка, природа которого — невинность, игра и спонтанность. Смейся над самим собой, растворяя всякую напыщенность и серьёзность! Наслаждайся своей невесомостью и многоцветием иллюзий! Юмор и смех помогут тебе стать неуязвимым.",
      "chakra": "Горловая чакра",
      "finger": "Указательный палец левой руки",
      "direction": "Запад — трансформирует",
      "motto": "Моя игра — магия моей первозданной невинности."
    },
    {
      "name": "Жёлтый Человек (Эб)",
      "short": "Жёлтый Человек",
      "desc": "Свободная воля. Мудрость. Влияние. Получай и выражай силу Свободной Воли и Влияния. Настраивай свою свободную волю на целостность и самоуважение. Пробуждай способности, дремлющие в твоей человеческой форме, становясь созвучным с высшей, сияющей мудростью. Ощущай и выражай свою открытость ко всему человечеству! Чти мудрость спутников, идущих с тобой по жизненному пути.",
      "chakra": "Сердечная чакра",
      "finger": "Средний палец левой руки",
      "direction": "Юг — расширяет",
      "motto": "Я пожинаю урожай мудрости моей свободной воли."
    },
    {
      "name": "Красный Небесный Странник (Бэн)",
      "short": "Красный Небесный Странник",
      "desc": "Пространство. Пробуждённость. Исследование. Пророчество. Получай и выражай силу Пророчества и Пробуждённости. Активно участвуй в возрождении Земли согласно Пророчеству. Помогай ей возвратиться в её первозданное состояние райского сада! Неси миру священную весть о воссоединении Небес и Земли! Смело входя в неизведанное, помни, что твоя сила — в непривязанности к точкам отсчёта. Растворяй устоявшиеся мнения о себе! Исследуй внешнее и внутреннее пространство!",
      "chakra": "Чакра солнечного сплетения",
      "finger": "Безымянный палец левой руки",
      "direction": "Восток — инициирует",
      "motto": "В полной пробуждённости я исследую неизвестное."
    },
    {
      "name": "Белый Волшебник-Мудрец (Иш)",
      "short": "Белый Волшебник-Мудрец",
      "desc": "Вневременность. Восприимчивость. Волшебство. Получай и выражай силу Вневременности и Чарования. Открывай в себе восприимчивость радиальной природы времени — вечного «Сейчас»! Твоё сердце — врата Божественного Чарования. Стань мудрецом, прозрачным для всего спектра энергий, и магия жизни будет свободно твориться через тебя.",
      "chakra": "Корневая чакра (копчик)",
      "finger": "Мизинец левой руки",
      "direction": "Север — очищает",
      "motto": "Чары вневременности источаются моим восприимчивым сердцем."
    },
    {
      "name": "Синий Орёл (Мэн)",
      "short": "Синий Орёл",
      "desc": "Видение. Разум. Созидание. Получай и выражай силы Видения и Разума. Сосредоточенность на созерцании Великого Плана поможет тебе воспарить, подобно орлу! Пусть твоё зрение будет ясным и острым! Творя силой разума, ты обретёшь вдохновение в преданности своему видению. Укрепляй своё взаимодействие с Планетарным Разумом!",
      "chakra": "Коронная чакра",
      "finger": "Большой палец левой ноги",
      "direction": "Запад — трансформирует",
      "motto": "Я предан своему видению Планетарного Разума."
    },
    {
      "name": "Жёлтый Воин (Киб)",
      "short": "Жёлтый Воин",
      "desc": "Интеллект. Бесстрашие. Способность вопрошать. Получай и выражай силы Бесстрашия и Интеллекта. Внимай своему внутреннему голосу, идя по тропе Космических Вех — от Оспаривания к Несомненности. Смело иди навстречу своим страхам! Ничему слепо не верь и исследуй явления жизни с помощью Божественного Интеллекта. Стань истинным Воином Благодати!",
      "chakra": "Горловая чакра",
      "finger": "Второй палец левой ноги",
      "direction": "Юг — расширяет",
      "motto": "Я есмь воин света со щитом интеллекта и мечом сострадания."
    },
    {
      "name": "Красная Земля (Кабан)",
      "short": "Красная Земля",
      "desc": "Навигация. Синхронность. Эволюция. Получай и выражай силу Навигации и Развития. Курс твоей пространственно-временной реальности одухотворяется синхронностью с твоей высшей тропой. Смело отмыкай врата Эволюции. Относись к нашей планете с любовью; чти и воспевай её первозданную святость.",
      "chakra": "Сердечная чакра",
      "finger": "Средний палец левой ноги",
      "direction": "Восток — инициирует",
      "motto": "Я прокладываю курс моей Планеты в синхронности с галактической эволюцией."
    },
    {
      "name": "Белое Зеркало (Эцнаб)",
      "short": "Белое Зеркало",
      "desc": "Бесконечность. Упорядоченность. Отражение. Медитация. Получай и выражай силы Отражения и Бесконечности. Стань зеркалом, отражающим свет Божественного Миропорядка. Учись видеть свои отражения в зеркалах людей и событий, отличая истинное от иллюзорного. Встречаясь лицом к лицу со своими теневыми сторонами, отпускай от себя всё, что отражает тебя искажённо. Откройся восприятию опыта бесконечности!",
      "chakra": "Чакра солнечного сплетения",
      "finger": "Безымянный палец левой ноги",
      "direction": "Север — очищает",
      "motto": "Я созерцаю бесконечные отражения Божественного."
    },
    {
      "name": "Синяя Буря (Кауак)",
      "short": "Синяя Буря",
      "desc": "Самопорождение. Энергизация. Ускорение всех процессов. Получай и выражай силу Самопорождающей Энергии. Высвобождая её, ты пробуждаешь своего внутреннего Громовержца! Ускоряй процессы преображения и инициируй очищение своей жизни! Самопорождение собственного освобождения — вполне в твоих силах.",
      "chakra": "Корневая чакра",
      "finger": "Мизинец левой ноги",
      "direction": "Запад — трансформирует",
      "motto": "Я несу в себе самопорождение свободы моей энергии и энергии моей свободы."
    },
    {
      "name": "Жёлтое Солнце (Ахау)",
      "short": "Жёлтое Солнце",
      "desc": "Вселенский Огонь. Жизнь. Просветление. Вознесение. Получай и выражай силы Вознесения и Просветления. Твоя цель — вознесение силой Вселенского Огня Просветления! Сияние твоего внутреннего солнца озаряет и насыщает энергией каждый момент твоей жизни. Тебе раскрывается осознание своей цельности и свободы. Наслаждайся опытом целостного восприятия матрицы жизни через линзу необусловленной любви.",
      "chakra": "Коронная чакра",
      "finger": "Большой палец правой руки",
      "direction": "Юг — расширяет",
      "motto": "Я есмь вселенский огонь — горючее для вознесения моей Планеты."
    }
];

// === 3) Основной маршрут ===
app.get('/calculate-kin', (req, res) => {
  const dateStr = req.query.date;
  if (!dateStr) return res.status(400).json({ error: "Укажи дату: ?date=YYYY-MM-DD" });

  const [year, month, day] = dateStr.split('-').map(Number);

  const jdInput = gregorianToJD(year, month, day);
  const jdEpoch = gregorianToJD(1987, 7, 26); // Dreamspell Epoch: 26 июля 1987
  const daysSinceEpoch = Math.floor(jdInput - jdEpoch);

  const KIN_EPOCH = 34; // Dreamspell эталон Kin на дату Epoch
  const CUSTOM_SHIFT = 1; // Настроено под yamaya.ru

  const kinNumber = ((daysSinceEpoch + KIN_EPOCH - 1 + CUSTOM_SHIFT) % 260 + 260) % 260 + 1;
  const toneNumber = ((kinNumber - 1) % 13) + 1;
  const sealIndex = ((kinNumber - 1) % 20);
  const sealData = SEALS_RU[sealIndex];

  res.json({
    input: dateStr,
    jd: jdInput,
    jdEpoch,
    daysSinceEpoch,
    kin: kinNumber,
    tone: toneNumber,
    seal: sealData
  });
});

// === 4) Корень ===
app.get('/', (req, res) => {
  res.send('✨ Kin Calculator API: добавь ?date=YYYY-MM-DD');
});

// === 5) Старт ===
app.listen(port, () => {
  console.log(`✅ Kin Calculator API на порту ${port}`);
});

app.use('/ai-plugin.json', express.static('./ai-plugin.json'));
app.use('/openapi.json', express.static('./openapi.json'));

